<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Min AI-modell (TFJS)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, sans-serif;
            max-width: 640px;
            margin: 2rem auto;
            padding: 1rem;
            background: #f6f7f9;
        }
        textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            font-size: 1rem;
        }
        button {
            margin-top: 1rem;
            padding: 12px 20px;
            font-size: 1rem;
            cursor: pointer;
        }
        #result {
            margin-top: 1.5rem;
            font-weight: bold;
            font-size: 1.1rem;
        }
        #tokens-box, #debug-box {
            margin-top: 1.5rem;
            padding: 0.75rem;
            background: #fff;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 0.85rem;
        }
        #debug-box {
            max-height: 180px;
            overflow-y: auto;
        }
        .ok { color: green; }
        .bad { color: #c00; }
    </style>
</head>

<body>

<h1>Testa min text-AI</h1>

<p>
    Skriv en <strong>engelsk</strong> mening från en biorecension.
</p>

<textarea id="textInput"
          placeholder="the movie was surprisingly good..."></textarea>

<button id="predictBtn" disabled>⏳ Laddar modell…</button>

<div id="result">Resultat visas här</div>

<div id="tokens-box">
    <strong>Tokens:</strong><br>
    <span id="tokensOutput">–</span>
</div>

<div id="debug-box"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const SEQUENCE_LENGTH = 256;
    let model = null;
    let metadata = null;

    const logBox = document.getElementById("debug-box");
    const log = (msg) => {
        const div = document.createElement("div");
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logBox.appendChild(div);
        logBox.scrollTop = logBox.scrollHeight;
        console.log(msg);
    };

    async function loadModel() {
        try {
            log("Laddar metadata…");
            const metaRes = await fetch("tfjs_model/metadata.json");
            metadata = await metaRes.json();

            log("Laddar TFJS-modell…");
            model = await tf.loadLayersModel("tfjs_model/model.json");

            // Warm-up
            tf.tidy(() => model.predict(tf.zeros([1, SEQUENCE_LENGTH])));

            document.getElementById("predictBtn").disabled = false;
            document.getElementById("predictBtn").textContent = "Analysera text";
            log("Modellen är redo ✅");

        } catch (e) {
            log("FEL: " + e.message);
        }
    }

    function tokenize(text) {
        const words = text
            .toLowerCase()
            .replace(/[^\w\s]/g, "")
            .split(/\s+/);

        const wordIndex = metadata.word_index;
        const OOV = 1;
        const PAD = 0;

        const seq = words.map(w => wordIndex[w] || OOV);

        const padded = new Array(SEQUENCE_LENGTH).fill(PAD);
        seq.slice(0, SEQUENCE_LENGTH).forEach((v, i) => padded[i] = v);

        document.getElementById("tokensOutput").textContent =
            words.map((w, i) => `${w}→${seq[i]}`).join(", ") || "–";

        return padded;
    }

    async function predict() {
        const text = document.getElementById("textInput").value.trim();
        if (!text) return;

        log(`Analyserar: "${text}"`);

        const input = tokenize(text);
        const tensor = tf.tensor2d([input]);

        const output = model.predict(tensor);
        const score = (await output.data())[0];

        tensor.dispose();
        output.dispose();

        const percent = (score * 100).toFixed(1);
        const result = document.getElementById("result");

        if (score > 0.5) {
            result.textContent = `Positiv recension (${percent}%)`;
            result.className = "ok";
        } else {
            result.textContent = `Negativ/neutral (${percent}%)`;
            result.className = "bad";
        }

        log(`Score: ${score}`);
    }

    document.getElementById("predictBtn").addEventListener("click", predict);

    loadModel();
});
</script>

</body>
</html>
